# CLAUDE.md â€” mystyleai MVP v2.1

> AI assistant guide for the **beyondfashion-ai/mystyleKPOP** repository.
> "From Prompt to Stage: Design your idol's stage outfit."

---

## 0. Language Policy (Strict)

1.  **Communication & Reporting:** Korean (Hangul)
    -   All chat messages, explanations, questions, and status reports to the user must be in **Korean**.
    -   Summaries of work done (e.g., in `notify_user`) must be in Korean.
2.  **Work, Code & Internal Logic:** English
    -   Code, variable names, commit messages, and complex technical documentation (unless requested otherwise) must be in **English**.
    -   *Exception:* User-facing text in the App UI (titles, captions) should follow the Hybrid strategy below.
3.  **App UI Content Strategy:** English + Korean (Hybrid)
    -   **Important Titles & Paragraphs:** Korean (e.g., Page Titles, Main Actions).
    -   **Detailed Labels/Secondary Text:** English is acceptable, but Korean is preferred for clarity.

## 0.1 IP & Content Policy (Strategic Decision)

**Core Strategy: User-Generated Content (UGC) + Future Partnerships**

1.  **System Strategy (AI Generation):**
    -   We use **"Style Archetypes"** (e.g., Girl Crush, High Teen, Cyber) for AI prompts to guide the look.
    -   We do **NOT** use real group names in AI prompts to avoid copyright/likeness issues.

2.  **Naming Strategy (Option B - UGC):**
    -   **No Pre-defined Options:** We do not provide a dropdown of real group names.
    -   **User Tagging:** Users manually type the group name they are designing for (e.g., "NewJeans", "BTS").
    -   **Platform Role:** We only display "Popular Tags" generated by users. The platform remains neutral.

3.  **Long-term Goal (Option C):**
    -   Build a massive database of fan designs first.
    -   Pitch to agencies later for official "Verified" group status using this data.



    -   Build a massive database of fan designs first.
    -   Pitch to agencies later for official "Verified" group status using this data.


## 0.2 Branding & Persona Policy (Strategic Decision)

**Target Audience: Female-centric K-POP Fandom**

-   **Core Insight:** The majority of K-POP content consumners and creators are female. The platform must resonate with their culture, language, and aesthetics.
-   **Decision Making Balance:** 
    -   **70% Female Perspective (Empathy, Trend, Fandom Culture)**
    -   **30% Male Perspective (Logic, System, Business)**
    -   *Why?* To balance the male CEO's decision-making with the actual user base's needs. Agents must actively advocate for the female user experience.

**Naming Convention (Soft & Fandom Ver 2.0):**
-   **Gallery** â†’ **ğŸ’– Style Pick (ìŠ¤íƒ€ì¼ í”½)**
-   **Studio** â†’ **âœ¨ Making Room (ë©”ì´í‚¹ ë£¸)**
-   **My Page** â†’ **ğŸ“’ Lookbook (ë£©ë¶)**
-   **Ranking** â†’ **ğŸ‘‘ Hall of Fame (ëª…ì˜ˆì˜ ì „ë‹¹)**
-   **Ranking** â†’ **ğŸ‘‘ Hall of Fame (ëª…ì˜ˆì˜ ì „ë‹¹)**
-   **Cheering Message (Core Branding):**
    -   Format: `@{User}ë‹˜ì´ {Target}ë¥¼ ì‘ì›í•©ë‹ˆë‹¤`
    -   Policy: **Never truncate.** Use `break-keep` to ensure the full sentence is always visible.
    -   Location: Design Cards, Detail Page, Success Modal.

---

## 1. Product Vision

**mystyleai** is a platform where KPOP fans design stage outfits using AI, share them in a community gallery, compete via voting/ranking, and the monthly winner receives a real costume manufactured from their design.

### Core Assumptions

- K-POP is driven by organized fandom behavior (goal-setting -> achievement).
- Existing fandom participation (voting, sharing) is strong, but there is no structure where "my creative output competes and connects to reality."

### Strategy: Create / Support / Boost

| Role        | Actions                                           |
| ----------- | ------------------------------------------------- |
| **Creator** | Generate / Save / Publish / Compete               |
| **Supporter** | Like (free vote)                                |
| **Booster** | Boost (Phase 2-A: visibility boost / Phase 2-B: paid vote = 1 ticket) |

### Key Differentiator (R2R: Result to Reality)

The monthly #1 winner's design is manufactured into a real costume and delivered, proving trust through tangible results.

### Product Principles

- Prompts and recipes are **private** (never exposed to other users)
- **No remix/copy** functionality
- All policies (voting, currency, visibility) must be expressible as a **public announcement sentence**
- Conflict will happen: design policies, permissions, and audit logs from day one

### Pay-to-Win Stance

- Currency is defined as "standardized support behavior"
- Like (free) and Boost (currency) are **always displayed and tallied separately**
- Expiration, refund, and conditions are fixed as announcement-ready text

### Repository Details

| Field        | Value                              |
| ------------ | ---------------------------------- |
| Organization | beyondfashion-ai                   |
| Repository   | mystyleKPOP                        |
| Domain       | my-style.ai                       |
| Status       | MVP Development                    |

---

## 2. Technology Stack

### Frontend

| Technology       | Details                          |
| ---------------- | -------------------------------- |
| Framework        | Next.js 14+ (App Router, `src/` directory) |
| Language         | TypeScript                       |
| Styling          | Tailwind CSS                     |
| UI Components    | Shadcn/ui (optional)            |
| State Management | React hooks + Context API        |
| Auth             | Firebase Authentication          |

### Backend

| Technology       | Details                                  |
| ---------------- | ---------------------------------------- |
| Platform         | Firebase (Firestore, Storage, Functions) |
| API Routes       | Next.js Route Handlers (`src/app/api/**/route.ts`) |
| Image Generation | fal.ai API (Flux 2 Pro model)                 |
| AI Stylist       | Google Gemini 2.0 Flash + Google Search Grounding |
| Translation      | Google Cloud Translation API             |
| Moderation       | Google Cloud Vision API (SafeSearch)     |

### Deployment

| Technology | Details                  |
| ---------- | ------------------------ |
| Hosting    | Vercel                   |
| Domain     | my-style.ai             |
| CDN        | Vercel Edge Network      |
| Monitoring | Sentry + Firebase Analytics |

---

## 3. Architecture Decisions (MVP)

### Directory Convention

- Use `src/app/` (Next.js official `src` support), not root `app/`.
- API routes live in `src/app/api/**/route.ts` (Route Handlers).

### Security Model: Server-Write Only

- **No client-side Firestore writes.** All mutations go through Next.js API routes.
- Admin role is determined exclusively by **Firebase Custom Claims** (`admin: true`).
- Counters (Like count, Boost count) are processed **atomically on the server** (increment / transaction).

### Like vs Boost Separation

- Like and Boost are **separate fields** in every data model.
- They are **separately displayed** on every UI surface.
- Ranking score formulas must be **publicly documented**.

---

## 4. User Roles & Permissions

| Role            | Generate    | Extra Gen (Credit) | Save Private | Publish | Like | Animate | Boost         |
| --------------- | ----------- | ------------------ | ------------ | ------- | ---- | ------- | ------------- |
| **Guest**       | 1 trial     | No                 | No           | No      | No   | No      | No            |
| **Free**        | 10/day      | Yes (Phase 2+)     | No           | Yes     | Yes  | No      | No            |
| **Superfan Pass** | 10/day    | Yes (Phase 2+)     | Yes          | Yes     | Yes  | Yes     | No            |
| **Booster**     | 10/day      | Yes (Phase 2+)     | Yes          | Yes     | Yes  | Yes     | Yes (Phase 2) |

---

## 5. Information Architecture (Routes)

| Route            | Page              | Description                        |
| ---------------- | ----------------- | ---------------------------------- |
| `/`              | Landing           | Hero CTA + Best Picks (API-driven) + How It Works |
| `/studio`        | Studio            | 4-step generation (IdolType/Concept/Keywords+Hashtags/ImageCount) |
| `/gallery`       | Explore           | Masonry grid + infinite scroll     |
| `/design/[id]`   | Detail            | Full view + Like + Boost + Share + Animate |
| `/ranking`       | Monthly Ranking   | Top 50 + phase-specific score text |
| `/login`         | Auth              | Email/Password login               |
| `/onboarding`    | Onboarding        | Preference survey after signup     |
| `/mypage`        | My Page           | User profile + my designs          |
| `/admin/*`       | Admin Console     | Moderation + operations            |

---

## 5.1 Current Code Overrides (Conflict Resolution)

If any older section in this document conflicts with the actual repository structure, use these values as the source of truth.

- App routes (current):
  - `/` -> `src/app/page.tsx`
  - `/studio` -> `src/app/studio/page.tsx`
  - `/gallery` -> `src/app/gallery/page.tsx`
  - `/design/[id]` -> `src/app/design/[id]/page.tsx`
  - `/ranking` -> `src/app/ranking/page.tsx`
  - `/mypage` -> `src/app/mypage/page.tsx`
  - `/login` -> `src/app/login/page.tsx`
  - `/onboarding` -> `src/app/onboarding/page.tsx`
  - `/about` -> `src/app/about/page.tsx`
- Ranking API (current):
  - `GET /api/ranking?period=weekly|monthly`
- Note:
  - Legacy examples that reference route groups like `(main)` or `(auth)` are historical and should not be treated as current file paths.

---

## 6. Project Structure

Legacy snapshot (for context). For active implementation decisions, use Section 5.1 above.

```
mystyleai/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ signup/
â”‚   â”‚   â”œâ”€â”€ (main)/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx                 # Landing page
â”‚   â”‚   â”‚   â”œâ”€â”€ studio/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx             # Generation studio
â”‚   â”‚   â”‚   â”œâ”€â”€ gallery/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx             # Explore (infinite scroll)
â”‚   â”‚   â”‚   â”œâ”€â”€ design/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ page.tsx         # Design detail page
â”‚   â”‚   â”‚   â”œâ”€â”€ ranking/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx             # Monthly ranking
â”‚   â”‚   â”‚   â””â”€â”€ account/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx             # My page
â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                 # Admin console
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ translate/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts            # Prompt translation
â”‚   â”‚   â”‚   â”œâ”€â”€ generate/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts            # AI image generation
â”‚   â”‚   â”‚   â”œâ”€â”€ simulate/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ agent/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ route.ts        # Agent simulation
â”‚   â”‚   â”‚   â”œâ”€â”€ designs/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ route.ts        # Design lookup
â”‚   â”‚   â”‚   â”œâ”€â”€ like/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [designId]/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ route.ts        # Like toggle
â”‚   â”‚   â”‚   â”œâ”€â”€ notifications/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts            # User notifications
â”‚   â”‚   â”‚   â”œâ”€â”€ stylist/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ feedback/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ route.ts        # AI Stylist feedback (Gemini 2.0 Flash)
â”‚   â”‚   â”‚   â”œâ”€â”€ gallery/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts            # Gallery listing
â”‚   â”‚   â”‚   â””â”€â”€ ranking/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts            # Monthly ranking query
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â””â”€â”€ globals.css
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/                          # Shared UI components
â”‚   â”‚   â”œâ”€â”€ Header.tsx                   # Main Header with Search/Noti
â”‚   â”‚   â”œâ”€â”€ SearchOverlay.tsx            # Header Search Overlay
â”‚   â”‚   â”œâ”€â”€ NotificationDropdown.tsx     # Header Notification Dropdown
â”‚   â”‚   â”œâ”€â”€ BottomNav.tsx                # Mobile Bottom Navigation
â”‚   â”‚   â”œâ”€â”€ CheeringBadge.tsx            # Cheering Message Component
â”‚   â”‚   â”œâ”€â”€ StylistFeedbackCard.tsx      # AI Virtual Stylist feedback UI (tabs + lock/unlock)
â”‚   â”‚   â”œâ”€â”€ studio/
â”‚   â”‚   â”‚   â”œâ”€â”€ GroupSelect.tsx          # Group/artist selection
â”‚   â”‚   â”‚   â”œâ”€â”€ ConceptSelect.tsx        # Concept selection
â”‚   â”‚   â”‚   â””â”€â”€ KeywordInput.tsx         # Keyword/prompt input
â”‚   â”‚   â”œâ”€â”€ gallery/
â”‚   â”‚   â”‚   â”œâ”€â”€ DesignCard.tsx           # Design card
â”‚   â”‚   â”‚   â””â”€â”€ FilterBar.tsx            # Filter bar
â”‚   â”‚   â””â”€â”€ design/
â”‚   â”‚       â”œâ”€â”€ ImageViewer.tsx          # Image viewer
â”‚   â”‚       â”œâ”€â”€ LikeButton.tsx           # Like button
â”‚   â”‚       â””â”€â”€ ShareButtons.tsx         # Social share buttons
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ stylist-personas.ts         # AI Virtual Stylist persona definitions & prompts
â”‚       â”œâ”€â”€ simulation-config.ts        # Agent personas & config
â”‚       â”œâ”€â”€ firebase/
â”‚       â”‚   â”œâ”€â”€ config.ts               # Firebase configuration
â”‚       â”‚   â”œâ”€â”€ admin.ts                # Firebase Admin SDK init
â”‚       â”‚   â”œâ”€â”€ auth.ts                 # Auth helpers
â”‚       â”‚   â”œâ”€â”€ firestore.ts            # Firestore helpers
â”‚       â”‚   â””â”€â”€ storage.ts              # Storage helpers
â”‚       â”œâ”€â”€ fal/
â”‚       â”‚   â””â”€â”€ client.ts               # fal.ai client
â”‚       â”œâ”€â”€ translation/
â”‚       â”‚   â””â”€â”€ client.ts               # Translation API client
â”‚       â””â”€â”€ utils.ts                     # Utility functions
â”œâ”€â”€ functions/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ ranking-snapshot.ts          # End-of-month ranking snapshot
â”‚   â”‚   â”œâ”€â”€ update-like-count.ts         # likeCount sync (atomic)
â”‚   â”‚   â””â”€â”€ reset-generation-limits.ts   # Daily limit reset
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ BOOTSTRAP_MVP.md                 # Setup & bootstrap guide
â”‚   â”œâ”€â”€ SECURITY_RULES.md                # Firestore security rules
â”‚   â”œâ”€â”€ DATA_MODEL.md                    # Full Firestore schema
â”‚   â”œâ”€â”€ API_CONTRACTS.md                 # API request/response specs
â”‚   â””â”€â”€ UX_SPEC_PLAYGROUND.md            # Studio UX specification
â”œâ”€â”€ public/
â”‚   â””â”€â”€ images/
â”œâ”€â”€ .env.local
â”œâ”€â”€ .env.example
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ package.json
â””â”€â”€ CLAUDE.md                            # This file
```

---

## 7. Core Pages & Features

### 7.1 Landing Page (`/`)

- Hero section: "ë‹¹ì‹ ì˜ íŒ¬ì‹¬ì´ í˜„ì‹¤ì´ ë˜ëŠ” ê³³" + "ì§€ê¸ˆ ë°”ë¡œ ë””ìì¸í•˜ê¸°" CTA
- **BEST PICKS section:** API-driven (`/api/gallery?sort=popular`), top 5 designs
  - 1st place: large card (aspect-4/3) with overlay info
  - 2nd-5th: horizontal scroll cards with rank badges
  - Each card links to `/design/[id]`
  - Empty state when no designs exist
- **"ì–´ë–»ê²Œ ì§„í–‰ë˜ë‚˜ìš”?" section:** 4-step process cards (í”„ë¡¬í”„íŠ¸ ì…ë ¥ â†’ AI ì˜ìƒ ìƒì„± â†’ ì»¤ë®¤ë‹ˆí‹° íˆ¬í‘œ â†’ ì‹¤ì œ ì˜ìƒ ì œì‘)
- Footer with brand + navigation links

### 7.2 Studio (`/studio`)

**4-step generation process (form always visible):**

1. **Idol Type:** girlgroup / boygroup / solo (3-column grid)
2. **Concept Style:** 7 concepts (cyber, y2k, highteen, sexy, suit, street + girlcrush for girlgroup only)
3. **Keywords + Hashtags:** Textarea with hashtag chips that append `#tags` directly into text
4. **Image Count:** 1ì¥ / 2ì¥ / 4ì¥ selector

**Preview (appears below form after generation):**
- Tap any image â†’ fullscreen popup
- Checkbox (top-right) to select/deselect images for publish
- First image auto-selected by default
- Multiple images can be published together
- Actions: [ê²°ê³¼ ì§€ìš°ê¸°] [ê°¤ëŸ¬ë¦¬ì— ê³µê°œ]

**Publish flow:**
- Bottom sheet modal (z-[60], above BottomNav)
- Shows selected images preview + concept tags + optional title/description
- Fixed bottom button: "ê°¤ëŸ¬ë¦¬ì— ê³µê°œí•˜ê¸°"
- Success screen with share buttons (Web Share, X, Link copy, KakaoTalk)

**AI Model:** fal-ai/flux-2/turbo
- Parameters: `guidance_scale: 3.5`, `num_inference_steps: 8`, random seed per image
- Prompt: natural language with randomized pose (10), angle (6), framing (4) per image
- See `docs/UX_SPEC_PLAYGROUND.md` for full specification

**AI Stylist Feedback (after generation):**
- Auto-fetches feedback from 4 virtual stylists via `/api/stylist/feedback`
- Studio shows 1 random stylist's feedback for free; other 3 locked behind rewarded ad
- Tab UI: persona avatar tabs with FREE/lock badges
- Card: profile header (name + MBTI + stylehouse), philosophy quote, bio, then feedback or lock prompt
- Select mode: user can pick a stylist whose advice to feature

### 7.3 Gallery (`/gallery`)

- Masonry grid layout
- Infinite scroll (loads 12 at a time)
- Each card: image, creator handle, Like count, timestamp
- Filters: concept, sort (newest / popular)

### 7.4 Design Detail (`/design/[id]`)

- Large image viewer (representative image selected by creator)
- Like button (login required, 1 per user per design)
- Boost button (Phase 2, displayed separately from Like)
- Share buttons (KakaoTalk, Instagram, X)
- Animate preview (if available)
- **AI Stylist Feedback:** All 4 stylists displayed in tab UI (all unlocked in display mode)
- Report button (moderation)
- **Prompt/recipe is never shown** to other users

### 7.5 Ranking (`/ranking`)

- Current month's Top 50 designs
- #1 highlighted: "This design will be manufactured into a real costume!"
- Phase-specific score text (Phase 1: Likes only; Phase 2-B: Likes + Boost Votes)
- Winner info submission form (within 7 days after month end)
- Past winner archive
- Countdown timer for remaining days

### 7.6 My Page (`/mypage`)

- User profile (handle, bio, profile image)
- My designs list (private + public)
- Total stats (generations, published, likes received)

### 7.7 Admin Console (`/admin`)

- Requires `admin: true` Custom Claim
- Content moderation queue
- User management (warnings, restrictions, bans)
- Monthly winner confirmation workflow
- Abuse detection logs

### 7.8 Growth Mechanics (Retention & Viral)

- **Daily Streak (Attendance):**
  - Logic: User must cast **3 Votes** daily to receive free credits (not just login).
  - Goal: Habit formation for "Supporter" role.
- **Share-to-Unlock:**
  - Logic: 1 of 4 generated images is blurred or high-res download is locked.
  - Unlock condition: **"Share to Friend"** (creates external link).
  - Goal: Organic viral loop without ad spend.

---

## 8. Monetization Phases

### Phase 1 (MVP): Likes-Based Ranking

- Ranking is determined by Like count only
- All voting is free
- Daily free generation limit: 10. No credit system yet.
- Revenue: none (user acquisition focus)

### Phase 2-A: Free Currency + Visibility Boost + AdSense

- Users earn free currency via missions/ads
- **Google AdSense** ads displayed in Gallery and Studio loading
- **Rewarded Ads**: Watch ad â†’ earn Credits for extra image generations
- Extra generations beyond daily limit (10) cost 1 Credit each
- Boost = visibility enhancement only (does NOT affect ranking score)
- Like and Boost displayed separately
- Revenue: ad-supported + currency education

### Phase 2-B: Paid Currency + Boost Vote

- Paid currency introduced
- **Ads removed or minimized**; free currency discontinued
- **Paid Generation Credits**: Purchase Credits via PayPal
  - Starter: 50 Credits / $0.99
  - Basic: 150 Credits / $2.49
  - Value: 500 Credits / $6.99
  - Pro: 1,200 Credits / $12.99
- Extra generations beyond daily limit (10) cost 1 Credit each
- Boost Vote: 1 currency = 1 vote (directly affects ranking score)
- Like and Boost Vote tallied and displayed separately
- Revenue: currency purchases

### AdSense Policy (Phase 2-A)

- **Gallery page**: Native in-feed ads between design cards (every 8th card)
- **Studio loading**: Display ad during 10-second generation wait
- **Ranking page footer**: Banner ad
- **Never on**: Design detail page (preserves immersive experience)
- AdSense publisher ID stored in environment variable `NEXT_PUBLIC_ADSENSE_PUB_ID`
- Removed or minimized when transitioning to Phase 2-B

---

## 9. Governance & Trust

### Abuse Prevention

- Rate limiting on all API endpoints
- Anomaly detection for voting patterns
- Escalation: warning -> restriction -> ban
- All moderation actions are logged with timestamps

### Monthly Winner Process

1. Month-end deadline (automatic snapshot)
2. Winner confirmation (admin review)
3. Production begins
4. Delivery to winner
5. Winner posts authentication/unboxing
6. Added to Hall of Fame

### Like/Boost Transparency

- Always display Like and Boost counts separately
- Never combine them into a single "score" without public formula
- Score calculation formula published in ranking page footer

---

## 10. Firestore Data Schema

> Full schema details: see `docs/DATA_MODEL.md`

### Collections Overview

| Collection          | Document ID Pattern         | Purpose                    |
| ------------------- | --------------------------- | -------------------------- |
| `designs`           | auto-generated              | All generated designs      |
| `likes`             | `{designId}_{uid}`          | Like records               |
| `generationLimits`  | `{uid}_{YYYY-MM-DD}`        | Daily generation counters  |
| `rankings`          | `monthly_{YYYY-MM}`         | Monthly ranking snapshots  |
| `users`             | Firebase Auth UID           | User profiles & stats      |

---

## 11. API Endpoints

> Full request/response specs: see `docs/API_CONTRACTS.md`

| Method   | Route                        | Auth Required | Description                |
| -------- | ---------------------------- | ------------- | -------------------------- |
| `POST`   | `/api/generate`              | No*           | Generate 1-4 outfit images (fal-ai/flux-2/turbo) |
| `POST`   | `/api/simulate/agent`        | No (Admin)    | Run simulation for specific agent (creates design/vote) |
| `POST`   | `/api/designs/publish`       | Optional      | Publish design with 1-4 images to gallery |
| `GET`    | `/api/designs/[id]`          | No            | Get design detail + creator designs + recommended |
| `POST`   | `/api/like/[designId]`       | Yes           | Toggle like on a design (trigger notification) |
| `GET`    | `/api/like/[designId]`       | No            | Check if user liked a design |
| `GET`    | `/api/notifications`         | Yes           | Get user's notification list |
| `GET`    | `/api/gallery`               | No            | List designs (sort, concept, cursor pagination) |
| `GET`    | `/api/ranking`               | No            | Get current month ranking  |
| `POST`   | `/api/stylist/feedback`      | No            | AI Stylist feedback (Gemini 2.0 Flash + Search Grounding) |
| `GET`    | `/api/community`             | No            | Community feed             |
| `GET`    | `/api/user/stats`            | No            | User design count & total likes |

*Auth not enforced in MVP; generation limits planned for Phase 2.

**Local dev fallback:** When Firebase is not configured, `/api/designs/publish`, `/api/gallery`, and `/api/designs/[id]` fall back to `data/designs.json` (local JSON file).

---

## 12. Environment Variables (`.env.local`)

```bash
# Firebase (client-side)
NEXT_PUBLIC_FIREBASE_API_KEY=
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=
NEXT_PUBLIC_FIREBASE_PROJECT_ID=
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=
NEXT_PUBLIC_FIREBASE_APP_ID=

# Firebase Admin (server-side only)
FIREBASE_ADMIN_PROJECT_ID=
FIREBASE_ADMIN_CLIENT_EMAIL=
FIREBASE_ADMIN_PRIVATE_KEY=

# fal.ai
FAL_KEY=

# Google Cloud Translation
GOOGLE_CLOUD_PROJECT_ID=
GOOGLE_CLOUD_TRANSLATION_KEY=

# Google Cloud Vision (moderation)
GOOGLE_CLOUD_VISION_KEY=

# Google Gemini (AI Virtual Stylist)
GOOGLE_GEMINI_API_KEY=

# Next.js
NEXT_PUBLIC_SITE_URL=https://my-style.ai

# Google AdSense (Phase 2-A)
NEXT_PUBLIC_ADSENSE_PUB_ID=
```

**IMPORTANT:**
- Never commit `.env.local` to Git.
- Only commit `.env.example` with empty placeholder values.

---

## 13. UI/UX Guidelines

### Design System

- **Primary Color:** Neon/gradient with KPOP aesthetic (e.g., pink-to-purple)
- **Fonts:** Pretendard (Korean), Inter (English)
- **Spacing:** Tailwind default (4px units)
- **Border Radius:** `rounded-lg` (8px)
- **Shadows:** `shadow-lg`

### Responsive Breakpoints

| Breakpoint | Width          |
| ---------- | -------------- |
| Mobile     | < 768px        |
| Tablet     | 768px ~ 1024px |
| Desktop    | > 1024px       |

### Accessibility

- All buttons must have `aria-label`
- All images must have `alt` text
- Support keyboard navigation (Tab, Enter)

---

## 14. Development Workflow

### Setup

```bash
npx create-next-app@latest mystyleai --typescript --tailwind --app --src-dir
npm install firebase @fal-ai/serverless-client @google-cloud/translate @google-cloud/vision
cp .env.example .env.local
# Fill in actual keys in .env.local
```

### Firebase Setup

1. Create a project in Firebase Console
2. Enable Firestore Database
3. Enable Storage
4. Enable Authentication (Email/Password)
5. Deploy Security Rules (see `docs/SECURITY_RULES.md`)
6. Set admin Custom Claims via Firebase Admin SDK

### Dev Server

```bash
npm run dev
```

### Build & Deploy

```bash
npm run build
vercel --prod
```

### Git Conventions

- **Default branch:** `main`
- **Feature branches:** `feature/<description>`
- **Bug fix branches:** `fix/<description>`
- **Commit messages:** Clear, imperative mood (e.g., "Add studio generation flow")
- **Commit signing:** Enabled (GPG/SSH)

---

## 15. AI Assistant Guidelines

### General Principles

1. **Read before writing** â€” Always read existing code before proposing changes
2. **Minimal changes** â€” Make only the changes requested; avoid unnecessary refactoring
3. **No over-engineering** â€” Keep solutions simple and focused on the task
4. **Security first** â€” Never commit secrets, credentials, or API keys
5. **Server-write only** â€” All Firestore mutations go through API routes, never client-side
6. **One task at a time** â€” Complete one feature fully before moving to the next

### Security Rules for AI

- Never expose user prompts/recipes to other users in any API response
- Always validate auth tokens server-side before mutations
- Use atomic operations for counters (Like count, generation count)
- Admin checks must use Custom Claims, never client-side role fields

### Code Style

- Follow the project's linter/formatter configuration
- Match the style of surrounding code
- Use clear, descriptive names for variables and functions
- Add comments only where logic is non-obvious

### Commit Practices

- Write clear, concise commit messages in imperative mood
- Stage specific files rather than using `git add -A`
- Never commit `.env`, credentials, or large binary files
- Verify changes with `git diff` before committing

### What to Avoid

- Do not add unnecessary dependencies
- Do not modify CI/CD pipelines without explicit permission
- Do not force-push or rewrite shared branch history
- Do not generate or guess URLs
- Do not expose prompts/recipes in gallery or detail views
- Do not combine Like and Boost into a single score without explicit instruction

---

## 16. Companion Documents

| Document                      | Purpose                                    |
| ----------------------------- | ------------------------------------------ |
| `docs/BOOTSTRAP_MVP.md`       | Step-by-step project setup guide           |
| `docs/SECURITY_RULES.md`      | Firestore security rules with explanations |
| `docs/DATA_MODEL.md`          | Full Firestore schema with all fields      |
| `docs/API_CONTRACTS.md`       | Complete API request/response contracts    |
| `docs/UX_SPEC_PLAYGROUND.md`  | Studio page UX specification               |
| `docs/GUIDELINES_2026-02-15.md` | Current live policy snapshot (Superstar/Ranking/UI) |
| `docs/TODO.md`                  | AI Virtual Stylist IP risk checklist & remaining tasks |

---

## 17. MVP Success Criteria

### Technical Success

- Login -> Prompt input -> 1 image generated within 5 seconds (4 for paid users)
- Select representative -> Publish -> Appears in gallery -> Others can Like
- Monthly auto-snapshot of Top 50 ranking
- Fully functional on mobile
- Admin can moderate content and confirm winners

### Business Success (3-month target)

| Metric                  | Target        |
| ----------------------- | ------------- |
| Monthly new users       | 5,000         |
| Monthly generations     | 2,000         |
| Published designs       | 600           |
| DAU/MAU activity ratio  | 30%           |

---

## Changelog

| Date       | Change                                                  |
| ---------- | ------------------------------------------------------- |
| 2026-02-10 | Initial CLAUDE.md created for empty repository          |
| 2026-02-10 | Full MVP spec: tech stack, schema, APIs, UI, checklist  |
| 2026-02-11 | v2 rewrite: product vision, roles, phases, governance, security decisions, src/ structure, companion docs |
| 2026-02-12 | v2.1 update: Growth mechanics (Daily Streak, Share-to-Unlock) added |
| 2026-02-12 | v2.2 update: Free tier = 1 image/generation, paid = 4 images. Model upgraded to fal-ai/flux-2-pro with JSON structured prompts |
| 2026-02-13 | v2.3 update: Studio UI finalized â€” 4-step form (idol/concept/keywords+hashtags/count), form always visible with preview below, multi-image publish, fullscreen popup, pose/angle/framing randomization, fal-ai/flux-2/turbo model. Landing page BEST PICKS section now API-driven from gallery data. Trending Styles removed. Local JSON fallback for dev without Firebase. Docs updated to match implementation. |
| 2026-02-14 | v2.4 Brand Update: Renamed main pages to Style Pick, Making Room, Lookbook, Hall of Fame. Updated Agent Persona to 70% Female / 30% Male balance. |
| 2026-02-14 | v2.5 System Update: Implemented User Activity Simulation (Agent Personas, Automated Generation, Voting). Added Notification System (Header Dropdown, Real-time Alerts for Likes/Votes). Activated Search Overlay. |
| 2026-02-15 | v2.6 Policy/UX: Superstar weekly cooldown (10x weight). v2.7 AI Virtual Stylist: 4 fictional CD personas, Gemini 2.0 Flash + Search Grounding, IP risk mitigation (dual-layer naming + output filter), rewarded ad monetization. |

---

*Keep this file up to date as the project evolves. When new tools, frameworks, or conventions are adopted, update the relevant sections.*

---

## 18. Current Policy Snapshot (2026-02-15)

- Superstar weight: `1 Superstar = 10 Likes`
- Superstar limit: once per week per account (global cooldown)
- Ranking score formula: `likeCount + (boostCount * 10)`
- UI must display Like and Superstar separately on major thumbnails/cards
- Detail page should avoid persistent policy clutter; use contextual popup for cooldown info

### Specialist Agents (Active in `agents/`)

- `agents/LEGAL.md`
- `agents/PRODUCT_MD.md`
- `agents/IP_STRATEGY.md`
- `agents/KPOP_EXPERT.md`

---

## 19. AI Virtual Stylist System (2026-02-15)

### Overview

4ëª…ì˜ ê°€ìƒ AI ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸ê°€ ì‚¬ìš©ìì˜ ë””ìì¸ì„ í‰ê°€í•©ë‹ˆë‹¤. ê° ìºë¦­í„°ëŠ” ë¹…4 ê¸°íšì‚¬ ì¶œì‹  ì „ì§ Creative Directorë¡œ, ë…ë¦½ ìŠ¤íƒ€ì¼í•˜ìš°ìŠ¤ë¥¼ ìš´ì˜í•˜ëŠ” ì„¤ì •ì…ë‹ˆë‹¤.

### Characters

| ID | Name | Stylehouse | MBTI | Background | Style DNA |
|----|------|-----------|------|------------|-----------|
| `nova` | ì°¨í•˜ì€ (Cha Ha-eun) | NOVA | INTJ | SN ì¶œì‹ , ê´‘ì•¼/SMCU ì„¤ê³„ | Neo-Culture, Chrome, Y3K |
| `onyx` | ìœ¤ì‹œí˜ (Yoon Si-hyuk) | ONYX | ISTP | YCC ì¶œì‹ , ì˜¬ë¸”ë™/WHO'S NEXT? | Dark Luxury, Power Shoulder |
| `lore` | ì„œìœ ì§„ (Seo Yu-jin) | LORE | INFP | HIBE ì¶œì‹ , í™”ì–‘ì—°í™” ì„œì‚¬ ì„¤ê³„ | Retro-Futurism, Narrative Wear |
| `prism` | í•œë„ìœ¤ (Han Do-yoon) | PRISM | ENFP | JIP ì¶œì‹ , ë„íŒŒë¯¼ ìŠ¤í…Œì´ì§• | Color Blocking, Sporty-Chic |

### IP Risk Mitigation (Dual-Layer Naming)

- **User-facing UI** (bios, stylehouse): Coded names â†’ SN, YCC, HIBE, JIP
- **System prompts** (internal, never exposed to users): Real company names â†’ SM, YG, HYBE, JYP
- **AI Output Filter**: `filterArtistNames()` â€” 50+ real K-POP artist/group names auto-replaced with "ì•„í‹°ìŠ¤íŠ¸"
- **Disclaimer**: "AI ë²„ì¶”ì–¼ ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸ Â· íŠ¹ì • ê¸°íšì‚¬ì™€ ê³µì‹ ê´€ê³„ ì—†ìŒ" (always visible in UI)

### Technical Implementation

| Component | File | Description |
|-----------|------|-------------|
| Persona Definitions | `src/lib/stylist-personas.ts` | 4 personas with full profiles, system prompts, search context |
| Feedback API | `src/app/api/stylist/feedback/route.ts` | Gemini 2.0 Flash + Google Search Grounding, output filter |
| Feedback UI | `src/components/StylistFeedbackCard.tsx` | Tab-based UI with lock/unlock, rewarded ad placeholder |

- **Model**: `gemini-2.0-flash` (not flash-lite; lite doesn't support tools)
- **Google Search Grounding**: `tools: [{ googleSearch: {} }]` for real-time trend references
- **Max tokens**: 300 (3 sentences per stylist)
- **Temperature**: 0.9

### Monetization (Stylist Advice)

| Phase | Model |
|-------|-------|
| **Current (MVP)** | 1st stylist free, remaining 3 locked behind rewarded ad (placeholder 2s delay) |
| **Phase 2-A** | Rewarded ad SDK integration (AdSense/AdMob) |
| **Phase 2-B** | Credits/paid currency to unlock premium stylist advice |

### Remaining Tasks

- [ ] Avatar images: `/images/stylists/nova|onyx|lore|prism.png`
- [ ] Terms of service: AI-generated content disclaimer clause
- [ ] Legal review before launch (company name references in career bios)
- See `docs/TODO.md` for full checklist

---

### Changelog Addendum (2026-02-15)

- v2.6 Policy/UX Update: Superstar changed to weekly global cooldown with 10x ranking weight.
- Gallery/ranking sorting aligned to weighted score.
- Like+Superstar metrics exposed across major thumbnails.
- Added specialist agents (LEGAL, PRODUCT_MD, IP_STRATEGY, KPOP_EXPERT).
- Added policy guideline doc: `docs/GUIDELINES_2026-02-15.md`.
- v2.7 AI Virtual Stylist: 4 fictional CD personas (NOVA/ONYX/LORE/PRISM), Gemini 2.0 Flash + Google Search Grounding, dual-layer company name masking, output filter for artist names, rewarded ad lock/unlock system, disclaimer UI.
